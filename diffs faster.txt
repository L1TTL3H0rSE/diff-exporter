param(
    [string]$sinceDate = "2024-01-01",
    [string]$untilDate = "2025-02-22",
    [string]$outputFile = $null, 
    [int]$diffContextLines = 0,
    [switch]$ignoreWhitespace = $true, 
    [switch]$wordDiff = $false,         
    [switch]$firstLineOnly = $false,
    [switch]$ignoreComments = $true
)

$excludePatterns = @(
    ':(exclude)package-lock.json', ':(exclude)yarn.lock', ':(exclude)pnpm-lock.yaml',
    ':(exclude)node_modules/*', ':(exclude)vendor/*', 
    ':(exclude).vscode/*', ':(exclude).idea/*', ':(exclude).editorconfig',
    ':(exclude).gitignore', ':(exclude).gitlab-ci.yml', ':(exclude).npmrc',
    ':(exclude)dist/*', ':(exclude)build/*', ':(exclude).output/*', ':(exclude).nuxt/*',
    ':(exclude)*.min.js', ':(exclude)*.min.css', ':(exclude)*.d.ts', 
    ':(exclude)auto-imports.d.ts', ':(exclude)components.d.ts',
    ':(exclude)*.stories.ts', ':(exclude).storybook/*',
    ':(exclude)packages/components/src/components/icons/*', 
    ':(exclude)*.svg', ':(exclude)*.png', ':(exclude)*.jpg', ':(exclude)*.ico',
    ':(exclude)*.json', # Убирает lottie, tsconfig и package.json (если package.json нужен, убери это)
    ':(exclude)test/*', ':(exclude)*.test.ts', ':(exclude)*.spec.ts',
    ':(exclude)packages/playground/*'
)

git rev-parse --is-inside-work-tree | Out-Null
if ($LASTEXITCODE -ne 0) {
    Write-Error "Ошибка: Скрипт должен быть запущен в корневой директории git-репозитория."
    exit 1
}

if (-not $outputFile) {
    $repoName = (Get-Item (git rev-parse --show-toplevel)).Name
    $branchName = (git rev-parse --abbrev-ref HEAD).Trim()
    $timestamp = Get-Date -Format "yyyyMMdd-HHmmss"
    $outputFile = "${repoName}_${sinceDate}_to_${untilDate}.md"
    # $outputFile = "${repoName}_${branchName}_${sinceDate}_to_${untilDate}.md"
    # $outputFile = "${repoName}_${branchName}_${sinceDate}_to_${untilDate}_${timestamp}.md"
    Write-Host "Имя выходного файла не указано, сгенерировано автоматически: $outputFile"
}

[Console]::OutputEncoding = [System.Text.Encoding]::UTF8
$absoluteOutputFile = Join-Path -Path (Get-Location) -ChildPath $outputFile
$writer = New-Object System.IO.StreamWriter($absoluteOutputFile, $false, [System.Text.Encoding]::UTF8)
$writer.WriteLine("# Ретроспективное код-ревью (оптимизировано для LLM)`n")
$writer.WriteLine("Период анализа: с $($sinceDate) по $($untilDate)`n")

Write-Host "Начинаю сбор информации..."

$commitBodyFormat = if ($firstLineOnly) { "%s" } else { "%s%n%b" }
$commitFormat = "`n## Коммит: %h | Автор: %an | Дата: %as`n**Сообщение:**`n``````text`n$($commitBodyFormat)`n``````n"

$allCommitHashes = git log --all --since=$sinceDate --until=$untilDate --reverse --pretty=format:"%H"
if (-not $allCommitHashes) {
    Write-Warning "Коммитов за указанный период не найдено."
    $writer.Close(); exit
}
$uniqueCommitHashes = $allCommitHashes | Get-Unique
$totalCommits = $uniqueCommitHashes.Length
$processedCount = 0

foreach ($hash in $uniqueCommitHashes) {
    $processedCount++
    Write-Progress -Activity "Анализ коммитов" -Status "Обработка $processedCount / $totalCommits" -PercentComplete (($processedCount / $totalCommits) * 100)

    $commitInfo = git show -s --pretty=format:$commitFormat $hash | Out-String
    
    $parentHashes = git log -n 1 --pretty=format:'%P' $hash
    $isMerge = ($parentHashes -and $parentHashes.Contains(" "))

    $diffOutput = ""
    if (-not $isMerge) {
        $gitShowArgs = @("show", $hash, "--pretty=format:''", "-U$($diffContextLines)")
        if ($ignoreWhitespace) { $gitShowArgs += "--ignore-all-space", "--ignore-blank-lines" }
        if ($wordDiff) { $gitShowArgs += "--word-diff=plain" }
        $gitShowArgs += @("--") + $excludePatterns
        
        $rawDiff = & git @gitShowArgs | Out-String

        if ($ignoreComments) {
            $commentPattern = '(?m)^[+-]\s*(\/\/.*|\/\*.*\*\/|\/\*.*|\*\s.*|.*\*\/)\r?\n'
            $rawDiff = $rawDiff -replace $commentPattern, ''
        }

        $cleanedDiff = $rawDiff -replace '(?m)^index .*\r?\n' -replace '(?m)^--- a.*\r?\n' -replace '(?m)^\+\+\+ b.*\r?\n' -replace '(?m)^@@ .*\r?\n' -replace '(?m)^new file mode .*\r?\n'
        $finalDiff = ""
        foreach ($line in $cleanedDiff.Split("`n")) {
            if ($line -match "^diff --git a/(.*) b/(.*)") {
                # Извлекаем имя файла из строки diff --git
                $fileName = $matches[2] 
                $finalDiff += "`n**Файл:** `$($fileName)``n"
            } elseif ($line.Trim() -ne "") {
                $finalDiff += "$line`n"
            }
        }
        $diffOutput = $finalDiff.Trim()
    }
    
    if ($isMerge -or ($diffOutput.Length -gt 0)) {
        $writer.WriteLine($commitInfo)
        if (-not $isMerge) {
            $writer.WriteLine("`n**Изменения:**`n``````diff`n$($diffOutput)`n``````n---")
        } else {
            $writer.WriteLine("`n*(Merge commit - файлы пропущены)*`n---")
        }
    }
}

$writer.Close()
$writer.Dispose()
Write-Host "Готово! Файл сохранен: $outputFile"